if(void 0===srlAdmin)var srlAdmin={data:new Date().toISOString().split("T")[0],istniejaceGodziny:{},domyslnaLiczbaPilotow:1,ajaxurl:"/wp-admin/admin-ajax.php",adminUrl:"/wp-admin/",nonce:""};var srlData=srlAdmin.data,srlIstniejaceGodziny=srlAdmin.istniejaceGodziny,srlDomyslnaLiczbaPilotow=srlAdmin.domyslnaLiczbaPilotow;jQuery(document).ready(function(a){var t=a("#srl-liczba-pilotow"),n=a("#srl-interwal");a("#srl-ustawienia-godzin");var o=a("#srl-tabele-pilotow"),i=a("#srl-planowane-godziny"),e=a("#srl-generuj-sloty"),r=a("#srl-generuj-pilot"),s=a("#srl-generuj-od"),l=a("#srl-generuj-do"),d=srlData,p=!1;function c(a,t){var n=[],o=!1,i=!1;if(t){if(t.dane_pasazera)try{var e=JSON.parse(t.dane_pasazera);o=e.ma_filmowanie||!1,i=e.ma_akrobacje||!1}catch(r){}o||i||(o=t.ma_filmowanie||!1,i=t.ma_akrobacje||!1)}else a&&a.dane_pasazera_cache&&(o=a.dane_pasazera_cache.ma_filmowanie||!1,i=a.dane_pasazera_cache.ma_akrobacje||!1);return o?n.push('<span style="color: #46b450; font-weight: bold;">z filmowaniem</span>'):n.push('<span style="color: #d63638;">bez filmowania</span>'),i?n.push('<span style="color: #46b450; font-weight: bold;">z akrobacjami</span>'):n.push('<span style="color: #d63638;">bez akrobacji</span>'),n.join(", ")}function u(){o.empty();for(var n=parseInt(t.val()),i=1;i<=n;i++){var e=a('<div class="srl-pilot-container" style="margin-bottom:30px; border:1px solid #ddd; padding:15px; border-radius:8px;"></div>');e.append('<h2 style="background:#0073aa; color:white; margin:0 -15px 15px -15px; padding:12px 15px; font-size:16px;">Pilot nr '+i+"</h2>");var r=a('<div class="srl-grupowe-funkcje" style="background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; padding:12px; margin-bottom:15px; display:flex; align-items:center; gap:15px; flex-wrap:wrap;"></div>');r.append('<label style="font-weight:500; margin:0; display:flex; align-items:center; gap:5px;"><input type="checkbox" class="srl-zaznacz-wszystkie" data-pilot="'+i+'"> Zaznacz wszystkie</label>'),r.append('<select class="srl-grupowa-zmiana-statusu" data-pilot="'+i+'" style="min-width:150px; padding:4px 8px; border:1px solid #ccd0d4; border-radius:3px;"><option value="">-- Zmień status --</option><option value="Wolny">Wolny</option><option value="Prywatny">Prywatny</option><option value="Zrealizowany">Zrealizowany</option><option value="Odwołany przez organizatora">Odwołany przez organizatora</option></select>'),r.append('<button class="button srl-grupowe-usun" data-pilot="'+i+'" style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:3px; cursor:pointer; font-size:13px;">Usuń zaznaczone</button>'),e.append(r);for(var s=a('<table class="widefat fixed" data-pilot-id="'+i+'"><thead><tr><th style="width:30px;"><input type="checkbox" class="srl-zaznacz-wszystkie-naglowek" data-pilot="'+i+'"></th><th style="width:30px;">Nr</th><th>Czas lotu</th><th>Status slotu</th><th>ID lotu</th><th>Dane pasażera</th><th>Akcje</th></tr></thead><tbody></tbody></table>'),l=srlIstniejaceGodziny[i]||[],p=0;p<l.length;p++)z(i,p+1,l[p],s);e.append(s),o.append(e)}console.log("Ładowanie nasłuch\xf3w..."),a(".srl-zaznacz-wszystkie, .srl-zaznacz-wszystkie-naglowek").off("change").on("change",function(){var t=a(this).data("pilot"),n=a(this).is(":checked");a('.srl-slot-checkbox[data-pilot="'+t+'"]').prop("checked",n)}),a(".srl-grupowa-zmiana-statusu").off("change").on("change",function(){var t=a(this).data("pilot"),n=a(this).val(),o=a(this);if(n){var i=a('.srl-slot-checkbox[data-pilot="'+t+'"]:checked');if(0===i.length){alert("Nie zaznaczono żadnych slot\xf3w."),o.val("");return}if(!confirm("Czy na pewno zmienić status "+i.length+' slot\xf3w na "'+n+'"?')){o.val("");return}var e=0,r=i.length;i.each(function(){var t=a(this).data("termin-id");y(t,n,0,"",null,function(){++e===r&&u()},!0)}),o.val("")}}),a(".srl-grupowe-usun").off("click").on("click",function(){var t=a(this).data("pilot"),n=a('.srl-slot-checkbox[data-pilot="'+t+'"]:checked');if(0===n.length){alert("Nie zaznaczono żadnych slot\xf3w do usunięcia.");return}if(confirm("Czy na pewno usunąć "+n.length+" zaznaczonych slot\xf3w?")){var o=0,i=n.length;n.each(function(){var t=a(this).data("termin-id");a.post(ajaxurl,{action:"srl_usun_godzine",termin_id:t,nonce:srlAdmin.nonce},function(a){o++,a.success?srlIstniejaceGodziny=a.data.godziny_wg_pilota:console.error("Błąd usuwania slotu:",a.data),o===i&&u()}).fail(function(){o++,console.error("Błąd połączenia przy usuwaniu slotu"),o===i&&u()})})}}),a(document).off("click",".srl-usun-button").on("click",".srl-usun-button",function(){var t=a(this).closest("tr"),n=t.data("termin-id"),o=a(this);confirm("Czy na pewno usunąć ten slot?")&&(o.prop("disabled",!0).text("Usuwanie..."),a.post(ajaxurl,{action:"srl_usun_godzine",termin_id:n,nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,t.fadeOut(300,function(){t.remove(),u()})):(alert("Błąd usuwania: "+a.data),o.prop("disabled",!1).text("Usuń"))}).fail(function(){alert("Błąd połączenia z serwerem"),o.prop("disabled",!1).text("Usuń")}))}),a(document).off("click",".srl-edytuj-button").on("click",".srl-edytuj-button",function(){var t=a(this).closest("tr"),n=t.data("termin-id"),o="Wolny",i=t.find("td:nth-child(4) span");if(i.length>0){var e=i.text().trim();e.includes("Wolny")?o="Wolny":e.includes("Prywatny")?o="Prywatny":e.includes("Zarezerwowany")?o="Zarezerwowany":e.includes("Zrealizowany")&&(o="Zrealizowany")}var r=t.find(".srl-czas-col").text(),s=r.match(/(\d{1,2}:\d{2}) - (\d{1,2}:\d{2})/),l=s?s[1]:"09:00",d=s?s[2]:"09:30";t.find(".srl-czas-col").data("original-text",r),t.find(".srl-czas-col").data("current-status",o),t.find(".srl-czas-col").html('<div style="display:flex; align-items:center; gap:5px; flex-wrap:wrap;"><input type="time" class="srl-edit-start" value="'+l+'" style="width:90px;"><span>-</span><input type="time" class="srl-edit-stop" value="'+d+'" style="width:90px;"><button class="button button-small button-primary srl-zapisz-godziny" data-termin-id="'+n+'" style="margin-left:5px;">Zapisz</button><button class="button button-small srl-anuluj-edycje-godzin" style="margin-left:2px;">Anuluj</button></div>')}),a(document).off("click",".srl-zapisz-godziny").on("click",".srl-zapisz-godziny",function(){var t=a(this),n=t.closest("tr"),o=t.data("termin-id"),i=n.find(".srl-czas-col").data("current-status")||"Wolny",e=n.find(".srl-edit-start").val(),r=n.find(".srl-edit-stop").val();if(!e||!r){alert("Podaj nowe godziny startu i zakończenia.");return}var s=/^[0-2]\d:[0-5]\d$/;if(!s.test(e)||!s.test(r)||g(r)<=g(e)){alert("Nieprawidłowe godziny lub koniec nie jest p\xf3źniej niż start.");return}t.prop("disabled",!0).text("Zapisywanie..."),a.post(ajaxurl,{action:"srl_zmien_slot",termin_id:o,data:d,godzina_start:e,godzina_koniec:r,status:i,klient_id:0},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Godziny zostały zaktualizowane!")):(alert("Błąd zapisu: "+a.data),t.prop("disabled",!1).text("Zapisz"))}).fail(function(){alert("Błąd połączenia z serwerem"),t.prop("disabled",!1).text("Zapisz")})}),a(document).off("click",".srl-anuluj-edycje-godzin").on("click",".srl-anuluj-edycje-godzin",function(){var t=a(this).closest("tr"),n=t.find(".srl-czas-col").data("original-text"),o=g(n.match(/(\d{1,2}:\d{2})/)[1]),i=g(n.match(/- (\d{1,2}:\d{2})/)[1]),e=n.match(/(\d{1,2}:\d{2} - \d{1,2}:\d{2})/)[1]+" ("+(i-o)+"min)";t.find(".srl-czas-col").html(e+' <button class="button button-small srl-edytuj-button" style="margin-left:10px; font-size:11px;">Edytuj godziny</button>')}),a(document).off("click",".srl-wypisz-slot-prywatny").on("click",".srl-wypisz-slot-prywatny",function(){var t=a(this).data("termin-id");confirm("Czy na pewno wyczyścić ten slot prywatny i zmienić status na wolny?")&&a.post(ajaxurl,{action:"srl_zmien_status_godziny",termin_id:t,status:"Wolny",klient_id:0,notatka:"",nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Slot został wyczyszczony i zmieniony na wolny.")):alert("Błąd: "+a.data)}).fail(function(){alert("Błąd połączenia z serwerem")})}),a(document).off("click",".srl-wypisz-klienta").on("click",".srl-wypisz-klienta",function(){var t=a(this).closest("tr").data("termin-id");confirm("Czy na pewno wypisać klienta i przywr\xf3cić slot jako wolny?")&&y(t,"Wolny",0,"",null,function(){u()})}),a(document).off("click",".srl-pokaz-dane-pasazera").on("click",".srl-pokaz-dane-pasazera",function(){var t,n,o=a(this).data("lot-id"),i=a(this).data("user-id");t=o,n=i,a.post(ajaxurl,{action:"srl_pobierz_szczegoly_lotu",lot_id:t,user_id:n,nonce:srlAdmin.nonce},function(a){a.success?$(a.data,"Szczeg\xf3ły lotu #"+t,!1):alert("Błąd: "+a.data)})}),a(document).off("click",".srl-przypisz-klienta").on("click",".srl-przypisz-klienta",function(){var t,n,o,i,e;n=a(this).data("termin-id"),i=a('<div class="srl-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>'),e=a('<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:8px; width:500px; max-width:90%; max-height:80%; overflow-y:auto;"></div>'),e.html(`
        <h3>Przypisz klienta do slotu</h3>
        <div style="margin-bottom:20px;">
            <label>Wyszukaj klienta:</label>
            <input type="text" id="srl-search-client" placeholder="Email, telefon, imię, nazwisko lub ID lotu..." style="width:100%; padding:8px; margin-top:5px;">
        </div>
        <div id="srl-search-results" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; display:none;"></div>
        <div style="margin-top:20px; text-align:right;">
            <button class="button" onclick="$(this).closest('.srl-modal').remove();">Anuluj</button>
        </div>
    `),i.append(e),a("body").append(i),a("#srl-search-client").on("input",function(){clearTimeout(o);var t=a(this).val();if(t.length<2){a("#srl-search-results").hide();return}o=setTimeout(function(){var o,i;o=t,i=n,a.post(ajaxurl,{action:"srl_wyszukaj_dostepnych_klientow",query:o},function(t){if(t.success&&t.data.length>0){var n="<h4>Znalezieni klienci z dostępnymi lotami:</h4>";t.data.forEach(function(a){n+='<div style="border:1px solid #ddd; padding:10px; margin:5px 0; cursor:pointer;" onclick="przypisKlienta('+i+", "+a.lot_id+", '"+a.nazwa+"')\">",n+="<strong>"+a.nazwa+"</strong><br>",n+="<small>Lot #"+a.lot_id+" - "+a.produkt+"</small>",n+="</div>"}),a("#srl-search-results").html(n).show()}else a("#srl-search-results").html("<p>Brak wynik\xf3w</p>").show()})},300)})}),a(document).off("click",".srl-pokaz-dane-prywatne").on("click",".srl-pokaz-dane-prywatne",function(){var t,n;n=a(this).data("termin-id"),a.post(ajaxurl,{action:"srl_pobierz_dane_prywatne",termin_id:n,nonce:srlAdmin.nonce},function(a){a.success&&a.data?$(a.data,"Szczeg\xf3ły lotu prywatnego",!0,n):alert("Brak danych do wyświetlenia")})}),a(document).off("click",".srl-przypisz-slot").on("click",".srl-przypisz-slot",function(){console.log("Kliknięto przycisk przypisz slot");var t,n,o,i=a(this).data("termin-id");console.log("terminId:",i),t=i,console.log("Wywołano pokazModalPrzypisaniaSlotu z terminId:",t),n=a('<div class="srl-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>'),(o=a('<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:8px; width:600px; max-width:90%; max-height:80%; overflow-y:auto;"></div>')).html(`
        <h3>Przypisz klienta do slotu</h3>
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">Wybierz typ przypisania:</label>
            <div style="display:flex; gap:15px;">
                <button id="srl-typ-wykupiony" class="button button-primary">Wykupiony lot</button>
                <button id="srl-typ-prywatny" class="button button-secondary">Lot prywatny</button>
            </div>
        </div>
        
        <div id="srl-sekcja-wykupiony" style="display:none;">
            <h4>Wyszukaj wykupiony lot</h4>
            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:end;">
                <div style="flex:1;">
                    <label>Szukaj w:</label>
                    <select id="srl-search-field" style="width:100%; padding:5px;">
                        <option value="wszedzie">Wszędzie</option>
                        <option value="email">Email</option>
                        <option value="id_lotu">ID lotu</option>
                        <option value="id_zamowienia">ID zam\xf3wienia</option>
                        <option value="imie_nazwisko">Imię i nazwisko</option>
                        <option value="login">Login</option>
                        <option value="telefon">Telefon</option>
                    </select>
                </div>
                <div style="flex:2;">
                    <label>Szukana fraza:</label>
                    <input type="text" id="srl-search-query" placeholder="Wprowadź szukaną frazę..." style="width:100%; padding:5px;">
                </div>
                <div>
                    <button id="srl-search-btn" class="button">Szukaj</button>
                </div>
            </div>
            <div id="srl-search-results" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; display:none;"></div>
        </div>
        
        <div id="srl-sekcja-prywatny" style="display:none;">
            <h4>Dane pasażera (lot prywatny)</h4>
            <form id="srl-form-prywatny">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label>Imię *</label>
                        <input type="text" name="imie" required style="width:100%; padding:8px; margin-top:5px;">
                    </div>
                    <div>
                        <label>Nazwisko *</label>
                        <input type="text" name="nazwisko" required style="width:100%; padding:8px; margin-top:5px;">
                    </div>
                    <div>
                        <label>Rok urodzenia *</label>
                        <input type="number" name="rok_urodzenia" min="1920" max="2020" required style="width:100%; padding:8px; margin-top:5px;">
                    </div>
                    <div>
                        <label>Numer telefonu *</label>
                        <input type="tel" name="telefon" required style="width:100%; padding:8px; margin-top:5px;">
                    </div>
                    <div>
                        <label>Sprawność fizyczna *</label>
                        <select name="sprawnosc_fizyczna" required style="width:100%; padding:8px; margin-top:5px;">
                            <option value="">Wybierz poziom sprawności</option>
                            <option value="zdolnosc_do_marszu">Zdolność do marszu</option>
                            <option value="zdolnosc_do_biegu">Zdolność do biegu</option>
                            <option value="sprinter">Sprinter!</option>
                        </select>
                    </div>
                    <div>
                        <label>Kategoria wagowa *</label>
                        <select name="kategoria_wagowa" required style="width:100%; padding:8px; margin-top:5px;">
                            <option value="">Wybierz kategorię wagową</option>
                            <option value="25-40kg">25-40kg</option>
                            <option value="41-60kg">41-60kg</option>
                            <option value="61-90kg">61-90kg</option>
                            <option value="91-120kg">91-120kg</option>
                            <option value="120kg+">120kg+</option>
                        </select>
                    </div>
                </div>
                <div style="grid-column: 1 / -1; margin-bottom:20px;">
                    <label>Dodatkowe uwagi</label>
                    <textarea name="uwagi" rows="3" style="width:100%; padding:8px; margin-top:5px;" placeholder="Np. alergie, obawy, specjalne potrzeby..."></textarea>
                </div>
                <div style="text-align:right;">
                    <button type="submit" class="button button-primary">Zapisz lot prywatny</button>
                </div>
            </form>
        </div>
        
        <div style="margin-top:20px; text-align:right; border-top:1px solid #ddd; padding-top:15px;">
            <button class="button srl-modal-anuluj">Anuluj</button>
        </div>
    `),n.append(o),a("body").append(n),n.find(".srl-modal-anuluj").on("click",function(t){t.preventDefault(),t.stopPropagation(),n.remove(),a(document).off("keydown.srl-przypisanie-modal")}),a(document).on("keydown.srl-przypisanie-modal",function(t){27===t.keyCode&&(n.remove(),a(document).off("keydown.srl-przypisanie-modal"))}),n.on("remove",function(){a(document).off("keydown.srl-przypisanie-modal")}),n.find("#srl-typ-wykupiony").on("click",function(t){t.preventDefault(),t.stopPropagation(),console.log("Kliknięto Wykupiony lot"),a(this).removeClass("button-secondary").addClass("button-primary"),n.find("#srl-typ-prywatny").removeClass("button-primary").addClass("button-secondary"),n.find("#srl-sekcja-wykupiony").show(),n.find("#srl-sekcja-prywatny").hide()}),n.find("#srl-typ-prywatny").on("click",function(t){t.preventDefault(),t.stopPropagation(),console.log("Kliknięto Lot prywatny"),a(this).removeClass("button-secondary").addClass("button-primary"),n.find("#srl-typ-wykupiony").removeClass("button-primary").addClass("button-secondary"),n.find("#srl-sekcja-prywatny").show(),n.find("#srl-sekcja-wykupiony").hide()}),n.find("#srl-search-btn").on("click",function(a){a.preventDefault(),a.stopPropagation(),_(t,n)}),n.find("#srl-search-query").on("keypress",function(a){13===a.which&&(a.preventDefault(),_(t,n))}),n.find("#srl-form-prywatny").on("submit",function(o){o.preventDefault(),o.stopPropagation(),function t(n,o,i){var e={};o.split("&").forEach(function(a){var t=a.split("=");2===t.length&&(e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))});var r={action:"srl_zapisz_lot_prywatny",termin_id:n,nonce:srlAdmin.nonce,imie:e.imie||"",nazwisko:e.nazwisko||"",rok_urodzenia:e.rok_urodzenia||"",telefon:e.telefon||"",sprawnosc_fizyczna:e.sprawnosc_fizyczna||"",kategoria_wagowa:e.kategoria_wagowa||"",uwagi:e.uwagi||""},s=i.find('#srl-form-prywatny button[type="submit"]');s.prop("disabled",!0).text("Zapisywanie..."),a.post(ajaxurl,r,function(t){t.success?a.ajax({url:ajaxurl,method:"GET",data:{action:"srl_pobierz_aktualne_godziny",data:srlData,nonce:srlAdmin.nonce},success:function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,i.remove(),u(),j("Lot prywatny został zapisany!")):(i.remove(),u(),j("Lot prywatny został zapisany!"))},error:function(){i.remove(),u(),j("Lot prywatny został zapisany!")}}):(s.prop("disabled",!1).text("Zapisz lot prywatny"),alert("Błąd: "+t.data))}).fail(function(a,t,n){s.prop("disabled",!1).text("Zapisz lot prywatny"),alert("Błąd połączenia z serwerem: "+n)})}(t,a(this).serialize(),n)})}),a(document).off("click",".srl-odwolaj-lot").on("click",".srl-odwolaj-lot",function(){var t=a(this).data("termin-id");if(confirm("Czy na pewno odwołać ten lot? Slot zostanie zachowany jako historia, a lot klienta będzie dostępny do ponownej rezerwacji.")){var n=a(this);n.prop("disabled",!0).text("Odwoływanie..."),a.post(ajaxurl,{action:"srl_anuluj_lot_przez_organizatora",termin_id:t,nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Lot został odwołany. Klient otrzymał powiadomienie, a lot jest dostępny do ponownej rezerwacji.")):(alert("Błąd: "+a.data),n.prop("disabled",!1).text("Odwołaj"))}).fail(function(){alert("Błąd połączenia z serwerem"),n.prop("disabled",!1).text("Odwołaj")})}}),a(document).off("click",".srl-przywroc-rezerwacje").on("click",".srl-przywroc-rezerwacje",function(){var t=a(this).data("termin-id");if(confirm("Czy na pewno przywr\xf3cić rezerwację? Klient zostanie ponownie przypisany do tego terminu.")){var n=a(this);n.prop("disabled",!0).text("Przywracanie..."),a.post(ajaxurl,{action:"srl_przywroc_rezerwacje",termin_id:t,nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Rezerwacja została przywr\xf3cona. Klient otrzymał powiadomienie.")):(alert("Błąd: "+a.data),n.prop("disabled",!1).text("Przywr\xf3ć rezerwację"))}).fail(function(){alert("Błąd połączenia z serwerem"),n.prop("disabled",!1).text("Przywr\xf3ć rezerwację")})}}),a(document).off("click",".srl-pokaz-dane-odwolane").on("click",".srl-pokaz-dane-odwolane",function(){var t;(function a(t){var n=null;if(Object.keys(srlIstniejaceGodziny).forEach(function(a){srlIstniejaceGodziny[a].forEach(function(a){a.id==t&&(n=a)})}),n){var o=function a(t,n){var o={tekstSlotu:"",maInformacje:!1,daneDoModalu:null},i=[];if(("Zarezerwowany"===t.status||"Zrealizowany"===t.status)&&t.klient_nazwa){var e=t.dane_pasazera_cache||null,r=null;if(t.notatka)try{var s=JSON.parse(t.notatka);"odwolany_przez_organizatora"===s.typ&&(r=s)}catch(l){}if(e||r){var d=e||r,p="Zarezerwowany"===t.status?"(ZAREZERWOWANY)":"Zrealizowany"===t.status?"(ZREALIZOWANY)":"";p&&i.push(p);var u=r?r.nazwa_produktu:"Lot w tandemie",z=c(t,r);i.push("#"+t.lot_id+" | "+u+" "+z);var y=d.klient_nazwa||t.klient_nazwa||"";if(d.rok_urodzenia){var w=new Date().getFullYear()-parseInt(d.rok_urodzenia);y+=" ("+w+" lat)"}if(d.kategoria_wagowa&&(y+=", "+d.kategoria_wagowa),d.sprawnosc_fizyczna){var f={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};y+=", "+(f[d.sprawnosc_fizyczna]||d.sprawnosc_fizyczna)}if(y.trim()&&i.push(y),d.telefon&&i.push("Tel: "+d.telefon),d.uwagi&&d.uwagi.trim()){var g=d.uwagi.trim();!n&&g.length>50&&(g=g.substring(0,47)+"..."),i.push("Uwagi: "+g)}o.daneDoModalu=d}else i.push(t.klient_nazwa),t.lot_id&&(i.push("(ID: #"+t.lot_id+")"),n&&i.push("[Kliknij INFO w tabeli]"));o.maInformacje=!0}else if("Prywatny"===t.status){if(t.klient_nazwa)i.push("(PRYWATNY)"),i.push(t.klient_nazwa),o.maInformacje=!0;else if(t.notatka)try{var m=JSON.parse(t.notatka);if(m.imie&&m.nazwisko){i.push("(PRYWATNY)"),i.push("Lot prywatny");var y=m.imie+" "+m.nazwisko;if(m.rok_urodzenia){var w=new Date().getFullYear()-parseInt(m.rok_urodzenia);y+=" ("+w+" lat)"}if(m.kategoria_wagowa&&(y+=", "+m.kategoria_wagowa),m.sprawnosc_fizyczna){var f={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};y+=", "+(f[m.sprawnosc_fizyczna]||m.sprawnosc_fizyczna)}if(i.push(y),m.telefon&&i.push("Tel: "+m.telefon),m.uwagi&&m.uwagi.trim()){var g=m.uwagi.trim();!n&&g.length>50&&(g=g.substring(0,47)+"..."),i.push("Uwagi: "+g)}o.daneDoModalu=m,o.maInformacje=!0}}catch(b){}}else if("Odwołany przez organizatora"===t.status&&t.notatka)try{var r=JSON.parse(t.notatka);if(r.klient_nazwa||r.imie&&r.nazwisko){i.push("(ODWOŁANY)");var u="Lot w tandemie",z=c(null,r);i.push("#"+t.lot_id+" | "+u+" "+z);var y=r.klient_nazwa||r.imie+" "+r.nazwisko;if(r.rok_urodzenia){var w=new Date().getFullYear()-parseInt(r.rok_urodzenia);y+=" ("+w+" lat)"}if(r.kategoria_wagowa&&(y+=", "+r.kategoria_wagowa),r.sprawnosc_fizyczna){var f={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};y+=", "+(f[r.sprawnosc_fizyczna]||r.sprawnosc_fizyczna)}if(i.push(y),r.telefon&&i.push("Tel: "+r.telefon),r.uwagi&&r.uwagi.trim()){var g=r.uwagi.trim();!n&&g.length>50&&(g=g.substring(0,47)+"..."),i.push("Uwagi: "+g)}o.daneDoModalu={imie:r.imie||(r.klient_nazwa?r.klient_nazwa.split(" ")[0]:""),nazwisko:r.nazwisko||(r.klient_nazwa?r.klient_nazwa.split(" ").slice(1).join(" "):""),rok_urodzenia:r.rok_urodzenia||"",telefon:r.telefon||"",kategoria_wagowa:r.kategoria_wagowa||"",sprawnosc_fizyczna:r.sprawnosc_fizyczna||"",uwagi:r.uwagi||""},o.maInformacje=!0}}catch(h){i.push("(ODWOŁANY)"),i.push("\uD83D\uDEAB LOT ODWOŁANY")}return o.tekstSlotu=i.join("\n"),o}(n,!1);o.daneDoModalu?$(o.daneDoModalu,"\uD83D\uDEAB Lot odwołany przez organizatora",!1):alert("Brak danych pasażera dla odwołanego lotu.")}else alert("Nie znaleziono danych slotu.")})(a(this).data("termin-id"))}),a(document).off("click",".srl-zrealizuj-lot").on("click",".srl-zrealizuj-lot",function(){var t=a(this).data("termin-id");if(confirm("Czy na pewno oznaczyć ten lot jako zrealizowany? Zachowane zostaną wszystkie dane pasażera i lotu.")){var n=a(this);n.prop("disabled",!0).text("Realizowanie..."),a.post(ajaxurl,{action:"srl_zrealizuj_lot",termin_id:t,nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Lot został oznaczony jako zrealizowany!")):(alert("Błąd: "+a.data),n.prop("disabled",!1).text("Zrealizuj"))}).fail(function(){alert("Błąd połączenia z serwerem"),n.prop("disabled",!1).text("Zrealizuj")})}}),a(document).off("click",".srl-zrealizuj-lot-prywatny").on("click",".srl-zrealizuj-lot-prywatny",function(){var t=a(this).data("termin-id");if(confirm("Czy na pewno oznaczyć ten lot prywatny jako zrealizowany? Zachowane zostaną wszystkie dane pasażera.")){var n=a(this);n.prop("disabled",!0).text("Realizowanie..."),a.post(ajaxurl,{action:"srl_zrealizuj_lot_prywatny",termin_id:t,nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),j("Lot prywatny został oznaczony jako zrealizowany!")):(alert("Błąd: "+a.data),n.prop("disabled",!1).text("Zrealizuj"))}).fail(function(){alert("Błąd połączenia z serwerem"),n.prop("disabled",!1).text("Zrealizuj")})}}),function n(){var o=a("#srl-harmonogram-container");if(o.empty(),!Object.keys(srlIstniejaceGodziny).some(function(a){return srlIstniejaceGodziny[a]&&srlIstniejaceGodziny[a].length>0})){o.html('<p style="text-align:center; color:#666; font-style:italic; padding:20px;">Brak zaplanowanych lot\xf3w na ten dzień</p>');return}for(var i=parseInt(t.val()),e=1440,r=0,s=1;s<=i;s++){var l=srlIstniejaceGodziny[s]||[];l.forEach(function(a){var t=g(a.start),n=g(a.koniec);e=Math.min(e,t),r=Math.max(r,n)})}e=60*Math.floor(Math.max(0,e-30)/60);var d=(r=60*Math.ceil(Math.min(1440,r+30)/60))-e,p=d/60*150+40,c=a('<div class="srl-harmonogram"></div>');c.css("height",p+"px");for(var u=a('<div class="srl-harmonogram-header"></div>'),s=1;s<=i;s++)u.append('<div class="srl-harmonogram-pilot-col">Pilot '+s+"</div>");c.append(u);var z=a('<div class="srl-harmonogram-time-axis"></div>');z.css("height",p-40+"px");for(var y=Math.floor(e/60);y<=Math.ceil(r/60);y++){var w=(60*y-e)/d*(p-40),f=a('<div class="srl-time-label-hour"></div>');f.css("top",Math.round(w)-10+"px"),f.text(m(y)+":00"),z.append(f);for(var k=15;k<60;k+=15){var v=(60*y+k-e)/d*(p-40),$=a('<div class="srl-time-label-minute"></div>');$.css("top",Math.round(v)-8+"px"),$.text(m(y)+":"+m(k)),z.append($)}}c.append(z);var x=a('<div class="srl-harmonogram-slots"></div>');x.css("height",p-40+"px");for(var y=Math.floor(e/60);y<=Math.ceil(r/60);y++){var w=(60*y-e)/d*(p-40),_=a('<div class="srl-grid-line-hour"></div>');_.css("top",Math.round(w)+"px"),x.append(_);for(var k=15;k<60;k+=15){var v=(60*y+k-e)/d*(p-40),j=a('<div class="srl-grid-line-minute"></div>');j.css("top",Math.round(v)+"px"),x.append(j)}}for(var s=1;s<=i;s++){var Z=(s-1)*300,B=a('<div class="srl-pilot-column-line"></div>');B.css("left",Z+"px"),x.append(B)}for(var s=1;s<=i;s++){var l=srlIstniejaceGodziny[s]||[],D=(s-1)*300;l.forEach(function(t){var n=g(t.start),o=g(t.koniec)-n,i=Math.round((n-e)/d*(p-40)),r=Math.round(o/d*(p-40))+1;r=Math.max(r,3);var s=b(t),l=!!t.klient_nazwa||!!t.notatka,c=Math.max(r,Math.max(16*s.split("\n").length+8,30));l&&(c=Math.max(c,120));var u=h(t.status),z=c>60?"10px":"9px",y=l?"500":"bold",w=a('<div class="srl-slot-harmonogram"></div>');w.css({top:i+"px",left:D+3+"px",width:"294px",height:c+"px",background:u.bg,border:"1px solid "+u.border,"font-size":z,"font-weight":y,color:u.text}),w.html(s.replace(/\n/g,"<br>")),w.on("click",function(){var n=a('tr[data-termin-id="'+t.id+'"]');n.length&&(a("html, body").animate({scrollTop:n.offset().top-100},500),n.css("background-color","#fff3cd").delay(2e3).queue(function(){a(this).css("background-color",""),a(this).dequeue()}))}),x.append(w)})}c.append(x);var I=a('<div class="srl-harmonogram-legenda"></div>');[{status:"Wolny",label:"Wolny"},{status:"Prywatny",label:"Prywatny"},{status:"Zarezerwowany",label:"Zarezerwowany"},{status:"Zrealizowany",label:"Zrealizowany"},{status:"Odwołany przez organizatora",label:"Odwołany"}].forEach(function(t){var n=h(t.status),o=a('<div class="srl-legend-item"></div>'),i=a('<div class="srl-legend-color"></div>');i.css({background:n.bg,"border-color":n.border});var e=a('<span class="srl-legend-label"></span>').text(t.label);o.append(i,e),I.append(o)}),o.append(c),o.append(I)}()}function z(t,n,o,i){var e=a('<tr data-termin-id="'+o.id+'"></tr>');e.append('<td><input type="checkbox" class="srl-slot-checkbox" data-pilot="'+t+'" data-termin-id="'+o.id+'"></td>'),e.append("<td>"+n+"</td>");var r=g(o.start),s=g(o.koniec),l=o.start+" - "+o.koniec+" ("+(s-r)+"min)",d=a('<td class="srl-czas-col"></td>');d.html(l+' <button class="button button-small srl-edytuj-button" style="margin-left:10px; font-size:11px;">Edytuj godziny</button> <button class="button button-secondary button-small srl-usun-button" style="margin-left:5px; font-size:11px;">Usuń</button>'),e.append(d);var p=a("<td></td>"),c="",u="";switch(o.status){case"Wolny":c="status-available",u="\uD83D\uDFE2";break;case"Prywatny":c="status-private",u="\uD83D\uDFE4";break;case"Zarezerwowany":c="status-reserved",u="\uD83D\uDFE1";break;case"Zrealizowany":c="status-completed",u="\uD83D\uDD35";break;case"Odwołany przez organizatora":c="status-cancelled",u="\uD83D\uDD34";break;default:c="status-unknown",u="⚪"}p.html('<span class="'+c+'" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">'+u+" "+o.status+"</span>"),e.append(p);var z=a("<td></td>");if(("Zarezerwowany"===o.status||"Zrealizowany"===o.status)&&o.lot_id)z.html('<a href="'+srlAdmin.adminUrl+"admin.php?page=srl-wykupione-loty&search_field=id_lotu&s="+o.lot_id+'" target="_blank" style="color:#0073aa; font-weight:bold;">#'+o.lot_id+"</a>");else if("Odwołany przez organizatora"===o.status&&o.notatka)try{var y=JSON.parse(o.notatka);y.lot_id?z.html('<a href="'+srlAdmin.adminUrl+"admin.php?page=srl-wykupione-loty&search_field=id_lotu&s="+y.lot_id+'" target="_blank" style="color:#dc3545; font-weight:bold;">#'+y.lot_id+" (odwołany)</a>"):z.html("—")}catch(w){z.html("—")}else"Prywatny"!==o.status&&("Zrealizowany"!==o.status||o.lot_id)?z.html("—"):z.html('<span style="color:#6c757d; font-weight:bold;">PRYWATNY</span>');e.append(z);var f=a("<td></td>");if("Zarezerwowany"===o.status||"Zrealizowany"===o.status&&o.lot_id)o.lot_id&&o.klient_nazwa?f.html('<button class="button button-small srl-pokaz-dane-pasazera" data-lot-id="'+o.lot_id+'" data-user-id="'+o.klient_id+'">'+o.klient_nazwa+"</button>"):f.html('<button class="button button-small srl-przypisz-klienta" data-termin-id="'+o.id+'">Przypisz klienta</button>');else if("Prywatny"===o.status||"Zrealizowany"===o.status&&o.notatka&&!o.lot_id){if(o.notatka)try{var m=JSON.parse(o.notatka);if(m.imie&&m.nazwisko){var b=m.imie+" "+m.nazwisko;"Zrealizowany"===o.status&&(b+=" (zrealizowany)"),f.html('<button class="button button-small srl-pokaz-dane-prywatne" data-termin-id="'+o.id+'">'+b+"</button>")}else f.html('<button class="button button-small srl-pokaz-dane-prywatne" data-termin-id="'+o.id+'">Dane prywatne</button>')}catch(h){f.html('<button class="button button-small srl-pokaz-dane-prywatne" data-termin-id="'+o.id+'">Dane prywatne</button>')}else f.html('<button class="button button-small srl-pokaz-dane-prywatne" data-termin-id="'+o.id+'">Dane prywatne</button>')}else if("Odwołany przez organizatora"===o.status){if(o.notatka)try{var y=JSON.parse(o.notatka);y.klient_nazwa?f.html('<button class="button button-small srl-pokaz-dane-odwolane" data-termin-id="'+o.id+'" style="background:#dc3545; color:white;">'+y.klient_nazwa+" (odwołany)</button>"):f.html('<span style="color:#dc3545; font-style:italic;">Lot odwołany</span>')}catch(k){f.html('<span style="color:#dc3545; font-style:italic;">Lot odwołany</span>')}else f.html('<span style="color:#dc3545; font-style:italic;">Lot odwołany</span>')}else f.html("—");e.append(f);var v=a("<td></td>");"Wolny"===o.status?v.append('<button class="button button-primary srl-przypisz-slot" data-termin-id="'+o.id+'">Przypisz klienta</button>'):"Zarezerwowany"===o.status&&o.klient_id>0?(v.append('<button class="button srl-wypisz-klienta">Wypisz klienta</button> '),v.append('<button class="button srl-zrealizuj-lot" data-termin-id="'+o.id+'" style="background:#28a745; color:white; margin-left:5px;">Zrealizuj</button> '),v.append('<button class="button srl-odwolaj-lot" data-termin-id="'+o.id+'" style="background:#dc3545; color:white; margin-left:5px;">Odwołaj</button>')):"Prywatny"===o.status?(v.append('<button class="button srl-zrealizuj-lot-prywatny" data-termin-id="'+o.id+'" style="background:#28a745; color:white; margin-right:5px;">Zrealizuj</button> '),v.append('<button class="button srl-wypisz-slot-prywatny" data-termin-id="'+o.id+'">Wyczyść slot</button>')):"Zrealizowany"===o.status?v.append('<span style="color:#28a745; font-weight:bold;">✅ Zrealizowany</span>'):"Odwołany przez organizatora"===o.status?v.append('<button class="button srl-przywroc-rezerwacje" data-termin-id="'+o.id+'" style="background:#28a745; color:white;">Przywr\xf3ć rezerwację</button>'):v.html("—"),e.append(v),i.find("tbody").append(e),function t(n,o){var i=n.find("tbody tr"),e=[];i.each(function(){var t=a(this),n=t.find(".srl-start-col").text()||t.find(".srl-edit-start").val(),o=t.find(".srl-stop-col").text()||t.find(".srl-edit-stop").val();n&&o&&e.push({start:g(n),koniec:g(o),wiersz:t})}),e.forEach(function(a){a.wiersz.css("background-color","")});for(var r=0;r<e.length;r++)for(var s=r+1;s<e.length;s++){var l=e[r],d=e[s];l.start<d.koniec&&d.start<l.koniec&&(l.wiersz.css("background-color","#fdd"),d.wiersz.css("background-color","#fdd"))}}(i,t)}function y(t,n,o,i,e,r,s){a.post(ajaxurl,{action:"srl_zmien_status_godziny",termin_id:t,status:n,klient_id:o||0,notatka:i||"",nonce:srlAdmin.nonce},function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,r?r():s||u()):(alert("Błąd zmiany statusu: "+a.data),e&&e.val(e.data("poprzedni")))}).fail(function(){alert("Błąd połączenia z serwerem"),e&&e.val(e.data("poprzedni"))})}function w(t,n){a.post(ajaxurl,{action:"srl_anuluj_lot_przez_organizatora",termin_id:t,nonce:srlAdmin.nonce},function(t){if(t.success){srlIstniejaceGodziny=t.data.godziny_wg_pilota,u();var o=a('<div style="position:fixed; top:50px; right:20px; background:#4CAF50; color:white; padding:10px 20px; border-radius:4px; z-index:9999;">Lot został odwołany i klient otrzymał powiadomienie</div>');a("body").append(o),setTimeout(function(){o.fadeOut(function(){o.remove()})},4e3)}else alert("Błąd: "+t.data),n.val(n.data("poprzedni"))}).fail(function(){alert("Błąd połączenia z serwerem"),n.val(n.data("poprzedni"))})}function f(t,n,o,i){var e;t.on("input",function(){var r=a(this).val();clearTimeout(e),n.find(".srl-wyniki-klientow").remove(),r.length<2||(e=setTimeout(function(){a.getJSON(ajaxurl,{action:"srl_wyszukaj_klientow_loty",q:r},function(n){if(n.success&&n.data.length>0){var e=a('<div class="srl-wyniki-klientow" style="position:absolute; background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; z-index:1000; width:200px; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-radius:4px;"></div>');n.data.forEach(function(t){var n=a('<div style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;">'+t.nazwa+"</div>");n.on("click",function(){y(o,"Zarezerwowany",t.id,"",i,function(){u()})}),n.on("mouseenter",function(){a(this).css("background","#f0f0f0")}).on("mouseleave",function(){a(this).css("background","white")}),e.append(n)}),t.after(e)}}).fail(function(){console.error("Błąd wyszukiwania klient\xf3w")})},300))}),a(document).on("click",function(t){a(t.target).closest(".srl-wyszukaj-klienta, .srl-wyniki-klientow").length||a(".srl-wyniki-klientow").remove()})}function g(a){var t=a.split(":");return 60*parseInt(t[0],10)+parseInt(t[1],10)}function m(a){return a<10?"0"+a:""+a}function b(a){var t=[];if(t.push(a.start+" - "+a.koniec+" ("+a.status.toUpperCase()+")"),a.lot_id)t.push("#"+a.lot_id+" - Lot w tandemie");else if("Odwołany przez organizatora"===a.status&&a.notatka)try{var n=JSON.parse(a.notatka);n.lot_id&&t.push("#"+n.lot_id+" - Lot odwołany")}catch(o){}else("Prywatny"===a.status||"Zrealizowany"===a.status&&a.notatka&&!a.lot_id)&&t.push("Lot prywatny");if("Prywatny"===a.status&&a.notatka)try{var i=JSON.parse(a.notatka);if(i.imie&&i.nazwisko){var e=i.imie+" "+i.nazwisko;if(i.rok_urodzenia){var r=new Date().getFullYear()-parseInt(i.rok_urodzenia);e+=" ("+r+" lat)"}if(i.kategoria_wagowa&&(e+=", "+i.kategoria_wagowa),i.sprawnosc_fizyczna){var s={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};e+=", "+(s[i.sprawnosc_fizyczna]||i.sprawnosc_fizyczna)}if(t.push(e),i.telefon&&t.push("Tel: "+i.telefon),i.uwagi&&i.uwagi.trim()){var l=i.uwagi.trim();l.length>40&&(l=l.substring(0,37)+"..."),t.push("Uwagi: "+l)}}}catch(d){}else if("Zrealizowany"===a.status&&a.notatka&&!a.lot_id)try{var i=JSON.parse(a.notatka);if(i.imie&&i.nazwisko){var e=i.imie+" "+i.nazwisko;if(i.rok_urodzenia){var r=new Date().getFullYear()-parseInt(i.rok_urodzenia);e+=" ("+r+" lat)"}if(i.kategoria_wagowa&&(e+=", "+i.kategoria_wagowa),i.sprawnosc_fizyczna){var s={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};e+=", "+(s[i.sprawnosc_fizyczna]||i.sprawnosc_fizyczna)}if(t.push(e),i.telefon&&t.push("Tel: "+i.telefon),i.uwagi&&i.uwagi.trim()){var l=i.uwagi.trim();l.length>40&&(l=l.substring(0,37)+"..."),t.push("Uwagi: "+l)}}}catch(p){}else if(("Zarezerwowany"===a.status||"Zrealizowany"===a.status)&&a.klient_nazwa){var c=a.dane_pasazera_cache||null;if(c){var e=a.klient_nazwa;if(c.rok_urodzenia){var r=new Date().getFullYear()-parseInt(c.rok_urodzenia);e+=" ("+r+" lat)"}if(c.kategoria_wagowa&&(e+=", "+c.kategoria_wagowa),c.sprawnosc_fizyczna){var s={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};e+=", "+(s[c.sprawnosc_fizyczna]||c.sprawnosc_fizyczna)}if(t.push(e),c.telefon&&t.push("Tel: "+c.telefon),c.uwagi&&c.uwagi.trim()){var l=c.uwagi.trim();l.length>40&&(l=l.substring(0,37)+"..."),t.push("Uwagi: "+l)}}else t.push(a.klient_nazwa),t.push("[Kliknij INFO w tabeli]")}else if("Odwołany przez organizatora"===a.status&&a.notatka)try{var n=JSON.parse(a.notatka);if(n.klient_nazwa||n.imie&&n.nazwisko){var e=n.klient_nazwa||n.imie+" "+n.nazwisko;if(n.rok_urodzenia){var r=new Date().getFullYear()-parseInt(n.rok_urodzenia);e+=" ("+r+" lat)"}if(n.kategoria_wagowa&&(e+=", "+n.kategoria_wagowa),n.sprawnosc_fizyczna){var s={zdolnosc_do_marszu:"Marsz",zdolnosc_do_biegu:"Bieg",sprinter:"Sprinter"};e+=", "+(s[n.sprawnosc_fizyczna]||n.sprawnosc_fizyczna)}if(t.push(e),n.telefon&&t.push("Tel: "+n.telefon),n.uwagi&&n.uwagi.trim()){var l=n.uwagi.trim();l.length>40&&(l=l.substring(0,37)+"..."),t.push("Uwagi: "+l)}}}catch(u){}return t.join("\n")}function h(a){switch(a){case"Wolny":return{bg:"#d4edda",border:"#28a745",text:"#155724"};case"Prywatny":return{bg:"#e2e3e5",border:"#6c757d",text:"#495057"};case"Zarezerwowany":return{bg:"#cce5ff",border:"#007bff",text:"#004085"};case"Zrealizowany":return{bg:"#d1ecf1",border:"#17a2b8",text:"#0c5460"};case"Odwołany przez organizatora":return{bg:"#f8d7da",border:"#dc3545",text:"#721c24"};default:return{bg:"#f8f9fa",border:"#6c757d",text:"#495057"}}}function k(t){var n=a('<div class="srl-modal" style="position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>'),o=a('<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:8px; width:600px; max-width:90%; max-height:80%; overflow-y:auto;"></div>');o.html(`
        <h3>🪪 Dane pasażera (lot prywatny)</h3>
        <form id="srl-form-dane-prywatne">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                <div>
                    <label>Imię *</label>
                    <input type="text" name="imie" required style="width:100%; padding:8px; margin-top:5px;">
                </div>
                <div>
                    <label>Nazwisko *</label>
                    <input type="text" name="nazwisko" required style="width:100%; padding:8px; margin-top:5px;">
                </div>
                <div>
                    <label>Rok urodzenia *</label>
                    <input type="number" name="rok_urodzenia" min="1920" max="2020" required style="width:100%; padding:8px; margin-top:5px;">
                </div>
                <div>
                    <label>Telefon *</label>
                    <input type="tel" name="telefon" required style="width:100%; padding:8px; margin-top:5px;">
                </div>
                <div>
                    <label>Sprawność fizyczna *</label>
                    <select name="sprawnosc_fizyczna" required style="width:100%; padding:8px; margin-top:5px;">
                        <option value="">Wybierz...</option>
                        <option value="zdolnosc_do_marszu">Zdolność do marszu</option>
                        <option value="zdolnosc_do_biegu">Zdolność do biegu</option>
                        <option value="sprinter">Sprinter!</option>
                    </select>
                </div>
                <div>
                    <label>Kategoria wagowa *</label>
                    <select name="kategoria_wagowa" required style="width:100%; padding:8px; margin-top:5px;">
                        <option value="">Wybierz...</option>
                        <option value="25-40kg">25-40kg</option>
                        <option value="41-60kg">41-60kg</option>
                        <option value="61-90kg">61-90kg</option>
                        <option value="91-120kg">91-120kg</option>
                        <option value="120kg+">120kg+</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label>Dodatkowe uwagi</label>
                <textarea name="uwagi" rows="3" style="width:100%; padding:8px; margin-top:5px;" placeholder="Np. alergie, obawy, specjalne potrzeby..."></textarea>
            </div>
            <div style="text-align:right;">
                <button type="button" class="button" onclick="$(this).closest('.srl-modal').remove();">Anuluj</button>
                <button type="submit" class="button button-primary" style="margin-left:10px;">Zapisz</button>
            </div>
        </form>
    `),n.append(o),a("body").append(n),a("#srl-form-dane-prywatne").on("submit",function(o){var i,e,r;o.preventDefault(),i=t,e=a(this).serialize(),r=n,a.post(ajaxurl,"[object Object]&"+e,function(a){a.success?(alert("Dane zostały zapisane!"),r.remove(),u()):alert("Błąd: "+a.data)})})}function v(t,n,o){confirm('Czy na pewno przypisać klienta "'+o+'" do tego slotu?')&&a.post(ajaxurl,{action:"srl_przypisz_klienta_do_slotu",termin_id:t,lot_id:n},function(t){t.success?(alert("Klient został przypisany pomyślnie!"),a(".srl-modal").remove(),u()):alert("Błąd: "+t.data)})}function $(t,n,o,i){var e="";e=t.imie&&t.nazwisko?t.imie+" "+t.nazwisko:t.imie?t.imie:t.nazwisko?t.nazwisko:"Brak danych";var r="";if(t.rok_urodzenia){var s=new Date().getFullYear()-parseInt(t.rok_urodzenia);r=t.rok_urodzenia+" ("+s+" lat)"}else r="Brak danych";var l,d=a('<div class="srl-modal-dane-pasazera" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;"></div>'),p=a('<div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; max-height: 90%; overflow-y: auto; width: 90%;"></div>'),c='<h3 style="margin-top: 0; color: #0073aa; border-bottom: 2px solid #0073aa; padding-bottom: 10px;">'+n+"</h3>";c+='<div id="srl-dane-wyswietl">',c+='<div style="line-height: 1.8; font-size: 15px;">',c+="<p><strong>Imię i nazwisko:</strong> "+e+"</p>",c+="<p><strong>Rok urodzenia:</strong> "+r+"</p>",c+="<p><strong>Telefon:</strong> "+(t.telefon||"Brak danych")+"</p>",c+="<p><strong>Sprawność fizyczna:</strong> "+(({zdolnosc_do_marszu:"Zdolność do marszu",zdolnosc_do_biegu:"Zdolność do biegu",sprinter:"Sprinter!"})[l=t.sprawnosc_fizyczna]||l||"Brak danych")+"</p>",c+="<p><strong>Kategoria wagowa:</strong> "+(t.kategoria_wagowa||"Brak danych")+"</p>",t.uwagi&&t.uwagi.trim()?c+="<p><strong>Uwagi:</strong> "+t.uwagi+"</p>":c+="<p><strong>Uwagi:</strong> Brak uwag</p>",c+="</div>",c+="</div>",o&&(c+='<div id="srl-dane-edytuj" style="display:none;">',c+='<form id="srl-form-edytuj-prywatne">',c+='<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">',c+='<div><label><strong>Imię *</strong></label><input type="text" name="imie" value="'+(t.imie||"")+'" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;"></div>',c+='<div><label><strong>Nazwisko *</strong></label><input type="text" name="nazwisko" value="'+(t.nazwisko||"")+'" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;"></div>',c+='<div><label><strong>Rok urodzenia *</strong></label><input type="number" name="rok_urodzenia" value="'+(t.rok_urodzenia||"")+'" min="1920" max="2020" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;"></div>',c+='<div><label><strong>Telefon *</strong></label><input type="tel" name="telefon" value="'+(t.telefon||"")+'" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;"></div>',c+='<div><label><strong>Sprawność fizyczna *</strong></label><select name="sprawnosc_fizyczna" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;">',c+='<option value="">Wybierz...</option>',[{value:"zdolnosc_do_marszu",label:"Zdolność do marszu"},{value:"zdolnosc_do_biegu",label:"Zdolność do biegu"},{value:"sprinter",label:"Sprinter!"}].forEach(function(a){var n=t.sprawnosc_fizyczna===a.value?"selected":"";c+='<option value="'+a.value+'" '+n+">"+a.label+"</option>"}),c+="</select></div>",c+='<div><label><strong>Kategoria wagowa *</strong></label><select name="kategoria_wagowa" required style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;">',c+='<option value="">Wybierz...</option>',["25-40kg","41-60kg","61-90kg","91-120kg","120kg+"].forEach(function(a){var n=t.kategoria_wagowa===a?"selected":"";c+='<option value="'+a+'" '+n+">"+a+"</option>"}),c+="</select></div>",c+="</div>",c+='<div style="margin-bottom:20px;"><label><strong>Dodatkowe uwagi</strong></label><textarea name="uwagi" rows="3" style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Np. alergie, obawy, specjalne potrzeby...">'+(t.uwagi||"")+"</textarea></div>",c+="</form>",c+="</div>"),c+='<div style="text-align:right; border-top:1px solid #ddd; padding-top:15px; margin-top: 20px;">',o&&(c+='<button id="srl-btn-edytuj" class="button button-primary" style="margin-right:10px;">Edytuj dane</button>',c+='<button id="srl-btn-zapisz" class="button button-primary" style="display:none; margin-right:10px;">Zapisz zmiany</button>',c+='<button id="srl-btn-anuluj-edycje" class="button" style="display:none; margin-right:10px;">Anuluj</button>'),c+='<button class="button srl-btn-zamknij">Zamknij</button>',c+="</div>",p.html(c),d.append(p),a("body").append(d),o&&(d.find("#srl-btn-edytuj").on("click",function(){d.find("#srl-dane-wyswietl").hide(),d.find("#srl-dane-edytuj").show(),d.find("#srl-btn-edytuj").hide(),d.find("#srl-btn-zapisz, #srl-btn-anuluj-edycje").show()}),d.find("#srl-btn-anuluj-edycje").on("click",function(){d.find("#srl-dane-edytuj").hide(),d.find("#srl-dane-wyswietl").show(),d.find("#srl-btn-zapisz, #srl-btn-anuluj-edycje").hide(),d.find("#srl-btn-edytuj").show()}),d.find("#srl-btn-zapisz").on("click",function(){x(i,d.find("#srl-form-edytuj-prywatne").serialize(),d)})),d.find(".srl-btn-zamknij").on("click",function(){d.remove(),a(document).off("keydown.srl-dane-modal")}),a(document).on("keydown.srl-dane-modal",function(t){27===t.keyCode&&(d.remove(),a(document).off("keydown.srl-dane-modal"))}),d.on("remove",function(){a(document).off("keydown.srl-dane-modal")})}function x(t,n,o){var i={};n.split("&").forEach(function(a){var t=a.split("=");2===t.length&&(i[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))});var e={action:"srl_zapisz_dane_prywatne",termin_id:t,nonce:srlAdmin.nonce,imie:i.imie||"",nazwisko:i.nazwisko||"",rok_urodzenia:i.rok_urodzenia||"",telefon:i.telefon||"",sprawnosc_fizyczna:i.sprawnosc_fizyczna||"",kategoria_wagowa:i.kategoria_wagowa||"",uwagi:i.uwagi||""};a.post(ajaxurl,e,function(a){a.success?(o.remove(),u(),j("Dane zostały zaktualizowane!")):alert("Błąd: "+a.data)}).fail(function(a,t,n){alert("Błąd połączenia z serwerem: "+n)})}function _(t,n){var o=n.find("#srl-search-field").val(),i=n.find("#srl-search-query").val();if(console.log("Debug - searchField:",o),console.log("Debug - query przed trim:","'"+i+"'"),i?(i=i.trim(),console.log("Debug - query po trim:","'"+i+"'"),console.log("Debug - query.length:",i.length)):(console.log("Debug - query jest null/undefined"),i=""),i.length<2){alert("Wprowadź co najmniej 2 znaki do wyszukania. Aktualna długość: "+i.length);return}a.post(ajaxurl,{action:"srl_wyszukaj_wolne_loty",search_field:o,query:i,nonce:srlAdmin.nonce},function(o){if(o.success&&o.data.length>0){var i="<h5>Znalezione loty:</h5>";o.data.forEach(function(a){i+='<div class="srl-lot-result" data-termin-id="'+t+'" data-lot-id="'+a.lot_id+'" data-klient-nazwa="'+a.klient_nazwa+'" style="border:1px solid #ddd; padding:15px; margin:5px 0; cursor:pointer; border-radius:4px;">',i+='<div style="font-weight:bold; color:#0073aa;">Lot #'+a.lot_id+" - Zam\xf3wienie #"+a.order_id+"</div>",i+='<div style="margin:5px 0;"><strong>'+a.klient_nazwa+"</strong> ("+a.email+")</div>",a.telefon&&(i+='<div style="font-size:12px; color:#666;">\uD83D\uDCDE '+a.telefon+"</div>"),i+="</div>"}),n.find("#srl-search-results").html(i).show(),n.find("#srl-search-results").off("click",".srl-lot-result").on("click",".srl-lot-result",function(){var t=a(this).data("termin-id"),o=a(this).data("lot-id"),i=a(this).data("klient-nazwa");(function t(n,o,i,e){if(confirm("Czy na pewno przypisać lot #"+o+" ("+i+") do tego slotu?")){var r=e.find('.srl-lot-result[data-lot-id="'+o+'"]');r.length&&(r.css("opacity","0.5").find("*").prop("disabled",!0),r.prepend('<span style="color: #0073aa; font-weight: bold;">⏳ Przypisywanie...</span><br>')),a.post(ajaxurl,{action:"srl_przypisz_wykupiony_lot",termin_id:n,lot_id:o,nonce:srlAdmin.nonce},function(t){t.success?a.ajax({url:ajaxurl,method:"GET",data:{action:"srl_pobierz_aktualne_godziny",data:srlData,nonce:srlAdmin.nonce},success:function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,e.remove(),u(),j("Wykupiony lot został przypisany do slotu!")):(e.remove(),u(),j("Lot został przypisany!"))},error:function(){e.remove(),u(),j("Lot został przypisany!")}}):(r.length&&(r.css("opacity","1").find("*").prop("disabled",!1),r.find("span:first").remove()),alert("Błąd: "+t.data))}).fail(function(){r.length&&(r.css("opacity","1").find("*").prop("disabled",!1),r.find("span:first").remove()),alert("Błąd połączenia z serwerem.")})}})(t,o,i,n)})}else n.find("#srl-search-results").html('<p style="color:#666; font-style:italic;">Brak wynik\xf3w dla podanej frazy.</p>').show()}).fail(function(){alert("Błąd wyszukiwania. Spr\xf3buj ponownie.")})}function x(t,n,o){var i={};n.split("&").forEach(function(a){var t=a.split("=");2===t.length&&(i[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))});var e={action:"srl_zapisz_dane_prywatne",termin_id:t,nonce:srlAdmin.nonce,imie:i.imie||"",nazwisko:i.nazwisko||"",rok_urodzenia:i.rok_urodzenia||"",telefon:i.telefon||"",sprawnosc_fizyczna:i.sprawnosc_fizyczna||"",kategoria_wagowa:i.kategoria_wagowa||"",uwagi:i.uwagi||""},r=o.find("#srl-btn-zapisz");r.prop("disabled",!0).text("Zapisywanie..."),a.post(ajaxurl,e,function(t){t.success?a.ajax({url:ajaxurl,method:"GET",data:{action:"srl_pobierz_aktualne_godziny",data:srlData,nonce:srlAdmin.nonce},success:function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,o.remove(),u(),j("Dane zostały zaktualizowane!")):(o.remove(),u(),j("Dane zostały zaktualizowane!"))},error:function(){o.remove(),u(),j("Dane zostały zaktualizowane!")}}):(r.prop("disabled",!1).text("Zapisz zmiany"),alert("Błąd: "+t.data))}).fail(function(a,t,n){r.prop("disabled",!1).text("Zapisz zmiany"),alert("Błąd połączenia z serwerem: "+n)})}function j(t){var n=a('<div style="position:fixed; top:20px; right:20px; background:#46b450; color:white; padding:15px 20px; border-radius:4px; z-index:9999; font-weight:bold;">✅ '+t+"</div>");a("body").append(n),setTimeout(function(){n.fadeOut(function(){n.remove()})},4e3)}i.is(":checked")&&Object.keys(srlIstniejaceGodziny).length>0&&u(),i.on("change",function(){if(a(this).is(":checked"))a("#srl-ustawienia-godzin").slideDown(),u();else{if(Object.keys(srlIstniejaceGodziny).some(function(a){return srlIstniejaceGodziny[a]&&srlIstniejaceGodziny[a].length>0})){alert('Nie możesz ustawić dnia jako „nielotny", ponieważ są już zaplanowane loty. Usuń wszystkie sloty, aby odznaczyć.'),a(this).prop("checked",!0);return}a("#srl-ustawienia-godzin").slideUp(),a("#srl-tabele-pilotow").empty()}}),a("#srl-wybierz-date").on("change",function(){var t,n,o=a(this).val(),i="data";window.location.href=(t=o,n=new URL(window.location.href),n.searchParams.set(i,t),n.toString())}),t.on("change",function(){i.is(":checked")&&(function a(){var n=parseInt(t.val());r.empty();for(var o=1;o<=n;o++)r.append('<option value="'+o+'">Pilot '+o+"</option>")}(),u())}),n.on("change",function(){i.is(":checked")&&u()}),e.on("click",function(t){if(t.preventDefault(),!p){var o=parseInt(r.val()),i=s.val(),c=l.val(),z=parseInt(n.val());if(!i||!c){alert("Podaj godzinę początkową i końcową.");return}var y=/^[0-2]\d:[0-5]\d$/;if(!y.test(i)||!y.test(c)){alert("Nieprawidłowy format godziny (HH:MM).");return}if(g(c)<=g(i)){alert("Godzina końcowa musi być p\xf3źniejsza niż godzina początkowa.");return}if(confirm("Czy na pewno wygenerować sloty dla Pilot "+o+" od "+i+" do "+c+" wg interwału "+z+" min?")){p=!0,e.prop("disabled",!0).text("Generowanie...");for(var w=g(i),f=g(c),b=[];w+z<=f;){var h=m(Math.floor(w/60))+":"+m(w%60),k=w+z;if(k>f)break;var v=m(Math.floor(k/60))+":"+m(k%60);b.push({start:h,koniec:v}),w=k}(function t(n,o,i,e){if(o>=n.length){e(o,!1);return}var r=n[o];a.ajax({url:ajaxurl,method:"POST",data:{action:"srl_dodaj_godzine",data:d,pilot_id:i,godzina_start:r.start,godzina_koniec:r.koniec,status:"Wolny",nonce:srlAdmin.nonce},success:function(a){a.success?(srlIstniejaceGodziny=a.data.godziny_wg_pilota,u(),t(n,o+1,i,e)):(console.error("Błąd przy dodawaniu slotu:",a.data),e(o,!0))},error:function(){e(o,!0)}})})(b,0,o,function(a,t){p=!1,e.prop("disabled",!1).text("Generuj sloty"),t&&alert("Wystąpił błąd przy generowaniu niekt\xf3rych slot\xf3w."),a>0&&alert("Wygenerowano "+a+" slot\xf3w dla Pilota "+o+".")})}}})});